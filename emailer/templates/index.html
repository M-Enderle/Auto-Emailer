<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Mail Editor</title>
    
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- TinyMCE Local -->
    <script src="/tinymce/tinymce.min.js"></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
{% raw %}
    <div id="app">
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">E-Mail Editor</h1>
                <p class="text-gray-600">Erstellen und versenden Sie professionelle E-Mails mit Rich-Text-Formatierung</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Email Form -->
            <div class="bg-white rounded-lg shadow-sm p-6 md:col-span-2">
                <form @submit.prevent="sendEmail" class="space-y-6">
                    <!-- From -->
                    <div>
                        <label for="fromAddress" class="block text-sm font-medium text-gray-700 mb-2">Absender</label>
                        <select
                            id="fromAddress"
                            v-model="emailData.from_address"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option v-for="acc in accounts" :key="acc.address" :value="acc.address">{{ acc.address }}</option>
                        </select>
                    </div>

                    <!-- Recipient -->
                    <div>
                        <label for="recipient" class="block text-sm font-medium text-gray-700 mb-2">Empfänger E-Mail</label>
                        <input
                            id="recipient"
                            v-model="emailData.recipient"
                            type="email"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="empfaenger@example.com"
                        >
                    </div>

                    <!-- Subject -->
                    <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">Betreff</label>
                        <input
                            id="subject"
                            v-model="emailData.betreff"
                            type="text"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Betreff eingeben"
                        >
                    </div>

                    <!-- Email Content -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail-Inhalt</label>
                        <div id="editor-container" class="border border-gray-300 rounded-md">
                            <textarea id="tinymce-editor" v-model="emailData.html_body"></textarea>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-between items-center pt-4">
                        <button
                            type="button"
                            @click="clearForm"
                            class="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors"
                        >
                            Leeren
                        </button>
                        
                        <button
                            type="submit"
                            :disabled="isLoading"
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center"
                        >
                            <svg v-if="isLoading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            {{ isLoading ? 'Senden...' : 'E-Mail senden' }}
                        </button>
                    </div>
                </form>

                <!-- Status Messages -->
                <transition name="fade">
                    <div v-if="statusMessage" class="mt-4 p-4 rounded-md" :class="statusClass">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg v-if="statusType === 'success'" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                <svg v-else class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium">{{ statusMessage }}</p>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>

            <!-- Sidebar: Bulk Sender -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold mb-4">Massenversand</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Empfänger-Excel (.xlsx)</label>
                        <input type="file" @change="onExcelSelected" accept=".xlsx,.xlsm" class="w-full" />
                        <p v-if="bulk.file_id" class="text-xs text-gray-500 mt-1">Hochgeladen: {{ bulk.file_id }}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Batch-Größe</label>
                            <input type="number" v-model.number="bulk.batch_size" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Intervall (Minuten)</label>
                            <input type="number" v-model.number="bulk.interval_minutes" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
                        </div>
                    </div>
                    <button :disabled="!bulk.file_id || isStarting" @click="startBulk" class="px-4 py-2 bg-emerald-600 text-white rounded-md disabled:opacity-50">
                        {{ isStarting ? 'Starte...' : 'Massenversand starten' }}
                    </button>
                </div>

                <h2 class="text-xl font-semibold mt-8 mb-2">Laufende Prozesse</h2>
                <div class="space-y-2 max-h-80 overflow-auto">
                    <div v-for="j in jobs" :key="j.id" class="border rounded-md p-3">
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span class="font-medium">{{ j.id.slice(0,8) }}</span>
                            <span class="text-gray-500">{{ j.status }}</span>
                            <button v-if="j.status !== 'completed' && j.status !== 'cancelled'"
                                    @click="cancelJob(j.id)"
                                    class="px-2 py-1 text-xs bg-red-600 text-white rounded-md hover:bg-red-700">
                                Abbrechen
                            </button>
                        </div>
                        <div class="mt-2 h-2 bg-gray-200 rounded">
                            <div class="h-2 bg-blue-600 rounded" :style="{width: ((j.sent / j.total) * 100).toFixed(1) + '%'}"></div>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">{{ j.sent }} / {{ j.total }} gesendet</div>
                        <div v-if="j.next_run" class="text-xs text-gray-500">Nächster Lauf: {{ new Date(j.next_run * 1000).toLocaleString() }}</div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
{% endraw %}

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    emailData: {
                        from_address: '',
                        recipient: '',
                        betreff: '',
                        html_body: ''
                    },
                    accounts: [],
                    bulk: { file_id: '', batch_size: 10, interval_minutes: 5 },
                    jobs: [],
                    isLoading: false,
                    isStarting: false,
                    statusMessage: '',
                    statusType: '',
                    editorInitialized: false
                }
            },
            computed: {
                statusClass() {
                    return this.statusType === 'success' 
                        ? 'bg-green-50 border border-green-200'
                        : 'bg-red-50 border border-red-200';
                }
            },
            mounted() {
                this.initTinyMCE();
                this.fetchAccounts();
                this.pollJobs();
            },
            methods: {
                 initTinyMCE() {
                     tinymce.init({
                         selector: '#tinymce-editor',
                         height: 400,
                         menubar: true,
                         base_url: '/tinymce',
                         plugins: [
                             'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                             'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                             'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons'
                         ],
                         language: 'de',
                         toolbar: 'undo redo | blocks | bold italic underline strikethrough | ' +
                                 'alignleft aligncenter alignright alignjustify | ' +
                                 'bullist numlist outdent indent | removeformat | ' +
                                 'link image media table | emoticons charmap | ' +
                                 'preview code fullscreen help',
                         content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; font-size: 14px }',
                         skin: 'oxide',
                         content_css: 'default',
                         branding: false,
                         promotion: false,
                         object_resizing: 'img',
                         image_dimensions: true,
                         // Image handling configuration
                         images_upload_handler: (blobInfo, progress) => {
                             return new Promise((resolve, reject) => {
                                 const formData = new FormData();
                                 formData.append('file', blobInfo.blob(), blobInfo.filename());
                                 
                                 fetch('/upload-image', {
                                     method: 'POST',
                                     body: formData
                                 })
                                 .then(response => response.json())
                                 .then(result => {
                                     if (result.location) {
                                         resolve(result.location);
                                     } else {
                                         reject('Upload failed');
                                     }
                                 })
                                 .catch(error => {
                                     reject('Upload failed: ' + error.message);
                                 });
                             });
                         },
                         // Allow pasting images from clipboard
                         paste_data_images: true,
                         // Convert images to base64 if upload fails
                         images_dataimg_filter: (img) => {
                             return img.hasAttribute('data-mce-src');
                         },
                         // Image dialog settings
                         image_advtab: true,
                         image_caption: true,
                         image_list: [
                             {title: 'Sample Image 1', value: 'https://via.placeholder.com/300x200?text=Sample+1'},
                             {title: 'Sample Image 2', value: 'https://via.placeholder.com/400x300?text=Sample+2'}
                         ],
                         setup: (editor) => {
                             editor.on('change keyup', () => {
                                 this.emailData.html_body = editor.getContent();
                             });
                         },
                        init_instance_callback: (editor) => {
                            this.editorInitialized = true;
                            // Set prefilled content
                            editor.setContent(this.emailData.html_body || '');
                        }
                     });
                 },
                async sendEmail() {
                    if (!this.editorInitialized) {
                        this.showStatus('Editor nicht bereit. Bitte kurz warten und erneut versuchen.', 'error');
                        return;
                    }

                    // Get content from TinyMCE
                    this.emailData.html_body = tinymce.get('tinymce-editor').getContent();

                    if (!this.emailData.html_body.trim()) {
                        this.showStatus('Bitte geben Sie einen Inhalt für die E-Mail ein.', 'error');
                        return;
                    }

                    this.isLoading = true;
                    this.statusMessage = '';

                    try {
                        const response = await fetch('/sendmail', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.emailData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showStatus('E-Mail erfolgreich gesendet!', 'success');
                        } else {
                            const error = await response.json();
                            this.showStatus(`Senden fehlgeschlagen: ${error.detail || 'Unbekannter Fehler'}`, 'error');
                        }
                    } catch (error) {
                        this.showStatus(`Netzwerkfehler: ${error.message}`, 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },
                async onExcelSelected(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const form = new FormData();
                    form.append('file', file, file.name);
                    const res = await fetch('/upload-recipients', { method: 'POST', body: form });
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        this.showStatus(err.detail || 'Upload fehlgeschlagen', 'error');
                        return;
                    }
                    const data = await res.json();
                    this.bulk.file_id = data.file_id;
                },
                async startBulk() {
                    if (!this.bulk.file_id) return;
                    this.isStarting = true;
                    try {
                        const payload = {
                            html_body: this.emailData.html_body,
                            betreff: this.emailData.betreff,
                            from_address: this.emailData.from_address,
                            batch_size: this.bulk.batch_size,
                            interval_minutes: this.bulk.interval_minutes,
                            file_id: this.bulk.file_id
                        };
                        const res = await fetch('/start-bulk', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({}));
                            this.showStatus(err.detail || 'Jobstart fehlgeschlagen', 'error');
                            return;
                        }
                        const data = await res.json();
                        this.showStatus(`Job started (${data.job_id})`, 'success');
                        this.pollJobsOnce();
                    } finally {
                        this.isStarting = false;
                    }
                },
                async pollJobsOnce() {
                    const res = await fetch('/jobs');
                    if (!res.ok) return;
                    const data = await res.json();
                    this.jobs = data.jobs || [];
                },
                pollJobs() {
                    this.pollJobsOnce();
                    setInterval(this.pollJobsOnce, 5000);
                },
                async cancelJob(jobId) {
                    try {
                        const res = await fetch(`/jobs/${jobId}/cancel`, { method: 'POST' });
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({}));
                            this.showStatus(err.detail || 'Konnte Job nicht abbrechen', 'error');
                            return;
                        }
                        this.showStatus('Job abgebrochen', 'success');
                        this.pollJobsOnce();
                    } catch (e) {
                        this.showStatus('Netzwerkfehler beim Abbrechen', 'error');
                    }
                },
                async fetchAccounts() {
                    try {
                        const res = await fetch('/mail-accounts');
                        if (!res.ok) throw new Error('Konten konnten nicht geladen werden');
                        const data = await res.json();
                        this.accounts = data.accounts || [];
                        if (this.accounts.length && !this.emailData.from_address) {
                            this.emailData.from_address = this.accounts[0].address;
                        }
                    } catch (e) {
                        this.showStatus(e.message, 'error');
                    }
                },
                clearForm() {
                    this.emailData = {
                        recipient: '',
                        betreff: '',
                        html_body: ''
                    };
                    if (this.editorInitialized) {
                        tinymce.get('tinymce-editor').setContent('');
                    }
                    this.statusMessage = '';
                },
                showStatus(message, type) {
                    this.statusMessage = message;
                    this.statusType = type;
                    
                    // Auto-hide success messages after 5 seconds
                    if (type === 'success') {
                        setTimeout(() => {
                            this.statusMessage = '';
                        }, 5000);
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
